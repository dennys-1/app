@model TiendaPc.Controllers.OfertasPageVm
@{
  ViewData["Title"] = "Ofertas";
  Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="flex items-baseline justify-between mb-4">
  <h1 class="text-2xl font-semibold">Ofertas</h1>
  <div class="flex items-center gap-2 text-sm">
    <span class="text-gray-600">Ordenar por:</span>
    <a class="px-3 py-1.5 rounded border @(Model.Orden=="fin"?"bg-black text-white":"")" href="/Ofertas?orden=fin">Finaliza</a>
    <a class="px-3 py-1.5 rounded border @(Model.Orden=="precio"?"bg-black text-white":"")" href="/Ofertas?orden=precio">Precio</a>
    <a class="px-3 py-1.5 rounded border @(Model.Orden=="nombre"?"bg-black text-white":"")" href="/Ofertas?orden=nombre">Nombre</a>
  </div>
</div>

@if (Model.Items.Count == 0)
{
  <div class="bg-yellow-50 border border-yellow-200 text-yellow-900 rounded p-4">
    No hay promociones activas por el momento. <a class="underline" href="/Catalogo/Index">Ir al catálogo</a>.
  </div>
}
else
{
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
    @foreach (var p in Model.Items)
    {
      var finIso = p.Fin.ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ");
      <div class="bg-white rounded-xl shadow p-4">
        <div class="h-36 bg-gray-100 rounded mb-2 flex items-center justify-center">IMG</div>
        <a class="font-medium hover:underline" href="/producto/@p.IdProducto">@p.Nombre</a>
        <div class="text-xs text-gray-500">SKU: @p.Sku</div>
        <div class="mt-2">
          <div class="text-sm line-through text-gray-400">S/ @p.PrecioNormal.ToString("0.00")</div>
          <div class="text-2xl font-bold">S/ @p.PrecioWeb.ToString("0.00")</div>
        </div>
        <div class="mt-2 text-xs text-gray-600">
          Finaliza en: <span class="font-semibold" data-countdown="@finIso"></span>
        </div>
        <a class="mt-3 inline-block px-3 py-2 bg-black text-white rounded" href="/producto/@p.IdProducto">Ver detalle</a>
      </div>
    }
  </div>

  <!-- Paginación -->
  <div class="flex justify-center gap-2 mt-6">
    @{
      var prev = Math.Max(1, Model.Pagina - 1);
      var next = Math.Min(Model.TotalPaginas, Model.Pagina + 1);
      string mkUrl(int p) => $"/Ofertas?orden={Model.Orden}&pagina={p}&tam={Model.Tam}";
    }
    <a class="px-3 py-2 rounded border @(Model.Pagina==1?"opacity-50 pointer-events-none":"")" href="@mkUrl(prev)">Anterior</a>
    <span class="px-3 py-2">Página @Model.Pagina de @Model.TotalPaginas</span>
    <a class="px-3 py-2 rounded border @(Model.Pagina==Model.TotalPaginas?"opacity-50 pointer-events-none":"")" href="@mkUrl(next)">Siguiente</a>
  </div>
}

@section Scripts{
<script>
  // Countdowns
  function updateCountdowns(){
    document.querySelectorAll('[data-countdown]').forEach(el=>{
      const end = new Date(el.getAttribute('data-countdown')).getTime();
      const now = Date.now();
      const diff = Math.max(0, end - now);
      const d = Math.floor(diff / (1000*60*60*24));
      const h = Math.floor((diff / (1000*60*60)) % 24);
      const m = Math.floor((diff / (1000*60)) % 60);
      const s = Math.floor((diff / 1000) % 60);
      el.textContent = `${d}d ${h}h ${m}m ${s}s`;
    });
  }
  updateCountdowns();
  setInterval(updateCountdowns, 1000);
</script>
}

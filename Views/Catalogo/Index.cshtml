@model TiendaPc.Controllers.CatalogoVm
@{
  ViewData["Title"] = "Catálogo";
  Layout = "~/Views/Shared/_Layout.cshtml";

  string mkUrl(int? cat=null, int? marca=null, string? q=null, decimal? min=null, decimal? max=null, string? orden=null, int? pag=null, int? t=null) {
    cat   ??= Model.Cat;
    marca ??= Model.Marca;
    q     ??= Model.Q;
    min   ??= Model.Min;
    max   ??= Model.Max;
    orden ??= Model.Orden;
    pag   ??= Model.Pag;
    t     ??= Model.T;
    return $"/Catalogo/Index?cat={cat}&marca={marca}&q={q}&min={min}&max={max}&orden={orden}&pag={pag}&t={t}";
  }
}

<div class="grid grid-cols-1 md:grid-cols-[260px_1fr] gap-6">
  <!-- Sidebar filtros -->
  <aside class="bg-white rounded-xl shadow p-4 h-max">
    <form method="get" action="/Catalogo/Index" class="space-y-4">
      <div>
        <label class="block text-sm font-semibold mb-1">Buscar</label>
        <input name="q" value="@Model.Q" class="w-full border rounded px-3 py-2" placeholder="RTX, Ryzen, monitor..." />
      </div>

      <div>
        <label class="block text-sm font-semibold mb-1">Categoría</label>
        <select name="cat" class="w-full border rounded px-3 py-2">
          <option value="">Todas</option>
          @foreach (var c in Model.Categorias) {
            <option value="@c.Id" @(Model.Cat==c.Id ? "selected" : "")>@c.Nombre</option>
          }
        </select>
      </div>

      <div>
        <label class="block text-sm font-semibold mb-1">Marca</label>
        <select name="marca" class="w-full border rounded px-3 py-2">
          <option value="">Todas</option>
          @foreach (var m in Model.Marcas) {
            <option value="@m.Id" @(Model.Marca==m.Id ? "selected" : "")>@m.Nombre</option>
          }
        </select>
      </div>

      <div>
        <label class="block text-sm font-semibold mb-1">Precio</label>
        <div class="flex gap-2">
          <input type="number" step="0.01" name="min" value="@(Model.Min?.ToString("0.##"))" class="w-1/2 border rounded px-3 py-2" placeholder="Mín" />
          <input type="number" step="0.01" name="max" value="@(Model.Max?.ToString("0.##"))" class="w-1/2 border rounded px-3 py-2" placeholder="Máx" />
        </div>
      </div>

      <div>
        <label class="block text-sm font-semibold mb-1">Ordenar por</label>
        <select name="orden" class="w-full border rounded px-3 py-2">
          <option value="relevancia" @(Model.Orden=="relevancia"?"selected":"")>Relevancia</option>
          <option value="precioAsc"  @(Model.Orden=="precioAsc" ?"selected":"")>Precio ↑</option>
          <option value="precioDesc" @(Model.Orden=="precioDesc"?"selected":"")>Precio ↓</option>
          <option value="nombre"     @(Model.Orden=="nombre"    ?"selected":"")>Nombre</option>
        </select>
      </div>

      <div class="flex items-center justify-between">
        <div class="text-xs text-gray-500">Resultados: <b>@Model.Total</b></div>
        <button class="px-3 py-2 bg-black text-white rounded">Aplicar</button>
      </div>

      <div class="text-right">
        <a class="text-xs text-gray-600 hover:underline" href="/Catalogo/Index">Limpiar filtros</a>
      </div>
    </form>
  </aside>

  <!-- Listado -->
  <section>
    <div class="flex items-center justify-between mb-3">
      <h1 class="text-2xl font-semibold">Catálogo</h1>
      <div class="text-sm text-gray-600">
        Página <b>@Model.Pag</b> de <b>@Model.TotalPaginas</b>
      </div>
    </div>

    @if (Model.Items.Count == 0)
    {
      <div class="bg-yellow-50 border border-yellow-200 text-yellow-900 rounded p-4">
        No se encontraron productos con los filtros seleccionados.
      </div>
    }
    else
    {
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        @foreach (var p in Model.Items)
        {
          <div class="bg-white rounded-xl shadow p-4 flex flex-col">
            <div class="h-36 bg-gray-100 rounded mb-2 flex items-center justify-center">IMG</div>
            <a class="font-medium hover:underline" href="/producto/@p.IdProducto">@p.Nombre</a>
            <div class="text-xs text-gray-500">SKU: @p.Sku</div>
            <div class="mt-2 font-bold">S/ @p.Precio.ToString("0.00")</div>

            <!-- Botón agregar al carrito -->
            <form method="post" action="/Carrito/Agregar" class="mt-3">
              <input type="hidden" name="idProducto" value="@p.IdProducto" />
              <button class="px-3 py-2 bg-black text-white rounded w-full">Agregar al carrito</button>
            </form>
          </div>
        }
      </div>

      <!-- Paginación -->
      <div class="flex justify-center gap-2 mt-6">
        @{
          var prev = Math.Max(1, Model.Pag - 1);
          var next = Math.Min(Model.TotalPaginas, Model.Pag + 1);
        }
        <a class="px-3 py-2 rounded border @(Model.Pag==1?"opacity-50 pointer-events-none":"")" href="@mkUrl(pag: prev)">Anterior</a>
        <span class="px-3 py-2">Página @Model.Pag de @Model.TotalPaginas</span>
        <a class="px-3 py-2 rounded border @(Model.Pag==Model.TotalPaginas?"opacity-50 pointer-events-none":"")" href="@mkUrl(pag: next)">Siguiente</a>
      </div>
    }
  </section>
</div>
